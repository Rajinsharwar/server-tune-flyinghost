name: Build LXD Image

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Image name/alias (e.g., imagev3)'
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract image name from commit message
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_NAME="${{ inputs.image_name }}"
            echo "Using manual trigger with image name: $IMAGE_NAME"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "Commit message: $COMMIT_MSG"
            
            # Extract image name from --release=<name>
            if echo "$COMMIT_MSG" | grep -q -- '--release='; then
              IMAGE_NAME=$(echo "$COMMIT_MSG" | grep -oP '(?<=--release=)[a-zA-Z0-9_-]+' | head -1)
              echo "Found release flag with image name: $IMAGE_NAME"
            else
              echo "No --release= flag found in commit message. Skipping build."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Validate image name (alphanumeric, hyphens, underscores only)
          if [[ ! "$IMAGE_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Error: Invalid image name '$IMAGE_NAME'. Only alphanumeric characters, hyphens, and underscores are allowed."
            exit 1
          fi
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
      
      - name: Install LXD client
        if: steps.extract.outputs.skip != 'true'
        run: |
          sudo snap install lxd --channel=latest/stable
          sudo lxd init --auto
      
      - name: Setup LXD remote authentication
        if: steps.extract.outputs.skip != 'true'
        env:
          LXD_HOST: ${{ secrets.LXD_HOST }}
          LXD_CERT_FILE: ${{ secrets.LXD_CERT_FILE }}
          LXD_CERT_PASS: ${{ secrets.LXD_CERT_PASS }}
        run: |
          echo "Setting up LXD remote connection to $LXD_HOST"
          
          # Decode and save certificate
          echo "$LXD_CERT_FILE" | base64 -d > /tmp/lxd-client.pfx
          
          # Extract certificate and key from PFX
          openssl pkcs12 -in /tmp/lxd-client.pfx -out /tmp/client.crt -clcerts -nokeys -passin pass:"$LXD_CERT_PASS"
          openssl pkcs12 -in /tmp/lxd-client.pfx -out /tmp/client.key -nocerts -nodes -passin pass:"$LXD_CERT_PASS"
          
          # Configure LXD client
          mkdir -p ~/.config/lxc
          
          # Add remote
          lxc remote add flyinghost "https://$LXD_HOST:8443" \
            --accept-certificate \
            --auth-type=tls
          
          # Copy client certificates
          sudo cp /tmp/client.crt ~/.config/lxc/client.crt
          sudo cp /tmp/client.key ~/.config/lxc/client.key
          sudo chmod 644 ~/.config/lxc/client.crt
          sudo chmod 600 ~/.config/lxc/client.key
          
          # Clean up
          rm -f /tmp/lxd-client.pfx /tmp/client.crt /tmp/client.key
          
          echo "LXD remote configured successfully"
      
      - name: Build LXD image
        if: steps.extract.outputs.skip != 'true'
        env:
          IMAGE_NAME: ${{ steps.extract.outputs.image_name }}
        run: |
          chmod +x scripts/build-image.sh
          ./scripts/build-image.sh "$IMAGE_NAME"
      
      - name: Build summary
        if: steps.extract.outputs.skip != 'true'
        run: |
          echo "## âœ… LXD Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Name:** ${{ steps.extract.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The LXD image has been successfully created and published." >> $GITHUB_STEP_SUMMARY
