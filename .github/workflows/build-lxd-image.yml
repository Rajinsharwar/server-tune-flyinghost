name: Build LXD Image

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Image name/alias (e.g., imagev3)'
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract image name from commit message
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_NAME="${{ inputs.image_name }}"
            echo "Using manual trigger with image name: $IMAGE_NAME"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "Commit message: $COMMIT_MSG"
            
            # Extract image name from --release=<name>
            if echo "$COMMIT_MSG" | grep -q -- '--release='; then
              IMAGE_NAME=$(echo "$COMMIT_MSG" | grep -oP '(?<=--release=)[a-zA-Z0-9_-]+' | head -1)
              echo "Found release flag with image name: $IMAGE_NAME"
            else
              echo "No --release= flag found in commit message. Skipping build."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Validate image name (alphanumeric, hyphens, underscores only)
          if [[ ! "$IMAGE_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Error: Invalid image name '$IMAGE_NAME'. Only alphanumeric characters, hyphens, and underscores are allowed."
            exit 1
          fi
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
      
      - name: Setup LXD Client
        if: steps.extract.outputs.skip != 'true'
        env:
          LXD_HOST: ${{ secrets.LXD_HOST }}
          LXD_TRUST_TOKEN: ${{ secrets.LXD_TRUST_TOKEN }}
        run: |
          echo "Setting up LXD remote connection to $LXD_HOST"
          
          # Install LXD client if not present
          if ! command -v lxc >/dev/null 2>&1; then
            echo "Installing LXD client..."
            sudo snap install lxd --channel=latest/stable
          else
            echo "LXD client already installed"
          fi
          
          # Add remote with trust token
          lxc remote add flyinghost "https://$LXD_HOST:8443" --auth-type=tls --accept-certificate <<EOF
          $LXD_TRUST_TOKEN
          EOF
          
          # Set as default remote
          lxc remote switch flyinghost
          
          # Verify connection (with detailed error reporting)
          if ! lxc list; then
            echo "Warning: Could not list containers. This may be due to permissions or network issues."
            echo "However, the remote has been configured. The build script may still work."
          fi
          
          echo "LXD remote configured successfully"
      
      - name: Build LXD image
        if: steps.extract.outputs.skip != 'true'
        env:
          IMAGE_NAME: ${{ steps.extract.outputs.image_name }}
        run: |
          chmod +x scripts/build-image.sh
          ./scripts/build-image.sh "$IMAGE_NAME"
      
      - name: Build summary
        if: steps.extract.outputs.skip != 'true'
        run: |
          echo "## âœ… LXD Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Name:** ${{ steps.extract.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The LXD image has been successfully created and published." >> $GITHUB_STEP_SUMMARY
