name: Build LXD Image

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      image_name:
        description: "LXD Image name to build"
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest

    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '--release=')

    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract image name from commit message

      - name: Extract image name
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_NAME="${{ github.event.inputs.image_name }}"
            echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
            echo "Manual run. Image name: $IMAGE_NAME"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            if [[ "$COMMIT_MSG" =~ --release=([a-zA-Z0-9._-]+) ]]; then
              IMAGE_NAME="${BASH_REMATCH[1]}"
              echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
              echo "Found image name from commit: $IMAGE_NAME"
            else
              echo "Error: Could not extract image name"
              exit 1
            fi
          fi
          
      - name: Decode LXD certificate
        run: |
          echo "${{ secrets.LXD_CERT_FILE }}" | base64 -d > /tmp/lxd.pfx
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          
      - name: Build and publish LXD image
        env:
          LXD_HOST: ${{ secrets.LXD_HOST }}
          LXD_CERT_FILE: /tmp/lxd.pfx
          LXD_CERT_PASS: ${{ secrets.LXD_CERT_PASS }}
          HOST_SSH_KEY_BASE64: ${{ secrets.HOST_SSH_KEY_BASE64 }}
          IMAGE_NAME: ${{ steps.extract.outputs.image_name }}
        run: |
          chmod +x scripts/build-image.sh
          ./scripts/build-image.sh
          
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/lxd.pfx
